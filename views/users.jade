doctype html
html
    head
        title #{title}
        meta(name='user page', content='width=device-width; initial-scale=1.0; maximum-scale=2.0; minimum-scale=1.0; user-scalable=yes;')
        link(rel='stylesheet', href='../public/stylesheets/userPage.css')
        script.
            function appendDevices() {
                let dataSet = !{JSON.stringify(data)}
                let l = dataSet.length;

                let deviceList = document.getElementById('devices');

                let i;
                for (i = 0; i < l; i++) { //iterate the data set by using the for loop
                    let deviceNum = dataSet[i].deviceNum;
                    let deviceName = dataSet[i].deviceName;

                    let div = document.createElement("div"); //new div tag that should be appended.
                    div.class = 'device';

                    let temperDiv = document.createElement('div')
                    temperDiv.id = 'temperature';

                    let temperature = dataSet[i].temperature;

                    let temperImg = document.createElement('img');
                    let temperSpan = document.createElement('span');

                    temperImg.id = 'temperatureImg';
                    temperSpan.id = 'temperatureVal';

                    temperImg.src = '../public/images/if_temperature_354242.svg'

                    let deviceNameSpan = document.createElement('span');
                    deviceNameSpan.innerText = deviceName;
                    deviceNameSpan.id = deviceName;

                    temperSpan.innerText = temperature + ' â„ƒ';

                    //add the onclick event listener to the temperature div tag.
                    temperDiv.onclick = function() {
                        redirectToDataPage(deviceNum);
                    };

                    let button = document.createElement('button');
                    button.innerText = 'change device name';
                    button.type = 'button';
                    button.onclick = function() {
                        let newName = prompt('Please input the new device name', deviceName);

                        //to do nothing if the user clicked the 'cancel' button
                        if (newName) {
                            changeTheDeviceName(deviceNum, newName, deviceName); //send the AJAX request to the server to change the device name.
                        }
                    }

                    temperDiv.appendChild(deviceNameSpan);
                    temperDiv.appendChild(temperImg);
                    temperDiv.appendChild(temperSpan);

                    div.appendChild(temperDiv); //append the div tag for the temperature to the div tag for the device info.
                    div.appendChild(button);
                    deviceList.appendChild(div); //add the child node to the div tag who's id is 'devices'.
                }
            }

            function changeTheDeviceName(deviceNum, deviceName, currentName) {
                let xhr = new XMLHttpRequest();

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === xhr.DONE) {
                        if (xhr.status === 200 || xhr.status === 201) {
                            document.getElementById(currentName).innerText = deviceName;
                        } else {
                            alert('Failed to change the device name!');
                        }
                    }
                }

                let data = { deviceNum: deviceNum, deviceName: deviceName, currentName: currentName };

                xhr.open('POST', window.location.href);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify(data));
            }

            function redirectToDataPage(deviceNum) {
                let currentURL = window.location.href;

                currentURL = currentURL.split('/user')[0];

                let url = `${currentURL}/data?deviceNum=${deviceNum}&user=` + document.getElementById('userID').innerText;

                window.location.href = url;
            }

            window.onload = appendDevices; //call the appendDevices function when the page is on load.
    body
        header(id='navigate_bar', class='navigate_bar')
            .navbarContainer
                nav(class='navbar navbar-light')
                    .navbar-collapse(id='header_navigator')
                        ul(class='navbar-nav')
                            li(class='nav-item')
                                a(class='nav-link', href='/', title='go to homepage', id='homeButton')
                                    img(src='../public/images/home.svg', id='home_link_image')
        h2(id='userID') User: #{user}
        div(class='devices', id='devices')